---
title: 성공과 실패를 결정하는 1%의 네트워크 원리 3장
uploadDate: 2022년 10월 03일
description: 성공과 실패를 결정하는 1%의 네트워크 원리를 읽은 후 내용을 정리한 블로그입니다.
---

이번 장은 허브, 라우터, 케이블에서 정보가 전달되는 과정을 설명한다. 이전 장에서 IP 담당 부분에 대한 이야기와 LAN 어댑터에 대한 내용을 이해했다면 이번 장의 내용이 크게 어렵진 않을 것이다. 컴퓨터도 결국은 IP 주소로 다음 라우터로 패킷을 보내야 하고 케이블로 다음 허브에 데이터를 전송해야 하므로 라우터가 하는 기능과 허브가 하는 기능 일부(대부분이라고 하는 게 맞는 듯싶다...)가 이미 있기 때문이다.

케이블에 대한 내용은 전류, 전압, 주파수 등의 관계를 알아야 이해가 간다. 전자기학을 싫어해도 물리학과였던 나는 그럭저럭 이해가 되었지만, 전기에 치를 떠시는 분들은 안 보시는 걸 추천한다. 이 정도 로우 레벨은 전자 공학과의 영역 아닐까 싶다.

### 01. 케이블과 리피터, 허브 속을 신호가 흘러간다

이번 장에서는 LAN 어댑터를 타고 나온 패킷이 리피터 허브, 스위칭 허브, 라우터를 거쳐서 인터넷으로 나가는 과정을 설명한다. 물론 우리 집만 해도 인터넷 회선 하나에 허브와 라우터 기능을 동시에 지원하는 와이파이 라우터 하나를 쓰지만 따로따로 설명하는 게 좋을 듯싶다.

#### 케이블

- 전기 신호가 케이블을 통과하는 사이에 신호의 에너지가 조금씩 떨어지기 때문에 허브에 도착했을 때는 신호가 약해진다. 그리고 신호가 케이블을 타고 이동하면서 만나게 되는 잡음으로 인해서 신호가 변형될 수 있다. 당연히 이에 대한 해결책도 있다.

- 먼저 신호선을 마주 꼬아서 잡음을 막는다. 잡음의 원인은 케이블 주위에서 발생하는 전자파인데 전자파는 금속 도선에 전류를 흐르게 할 수 있는 힘이 있고 이로 인해 신호선에 흐르는 전류의 흐름을 방해해서 잡음이 생기는 것이다. 이에 대한 해결 방법은 생각보다 간단한데 전자파에 닿은 금속 선 내부는 전자파 진행 방향과 이에 대한 금속 선의 상대적인 위치에 따라 다르게 흐르는 데 이를 이용해 선을 꼬면 금속 선의 상대적인 위치가 바뀌면서 어느 부분은 + 전류가 다른 부분은 -전류가 유도된다. 이렇게 전자파로 인해 생긴 유도 전류를 상쇄시키면서 잡음을 최소화한다.

- 잡음은 외부 전자파에서만 나오는 게 아니다. 케이블 내 전선의 경우 신호가 강하게 흐르지 않기 때문에 흘러나오는 전자파는 약하지만 서로 너무 가까이 있다는 게 문제다. 이렇게 인접한 신호선에 의한 잡음을 크로스토크라고 한다. 이 경우 전류의 흐름에 따라 전자기장이 생성되는 원리를 이용해 내부 전선들을 잘 배치하면 서로가 흘려보낸 전자파를 서로가 상쇄시키게 만들 수 있다.

- 이외에도 전자파를 차단하기 위해 금속막의 피복을 입히거나 선들의 간격을 일정하게 유지하기 위해 구분판을 넣는 등 전자기파 차단을 위해 여러 노력을 하고 있다.

현재 우리가 자주 쓰는 케이블 중 하나인 트위스트 페어 케이블도 내부에 신호선들이 꼬여있는 형태이다. 성능에 따라 여러 카테고리로 분류되어 있으며 적절한 케이블을 사용하면 된다. 요새는 빛을 이용한 광케이블도 있다.

#### 리피터 허브

- MDI / MDI-X, 크로스 케이블

  정보를 송신하는 컴퓨터에서 정보를 송신하는 회로는 결국 정보를 수신하는 컴퓨터의 정보를 수신하는 회로에 연결되어야 한다. 그래서 송신하는 회로에서 출발하는 신호선이 수신하는 회로에 도착할 수 있도록 중간에 신호선을 한번 교차시켜야 한다. 케이블을 교차시킨 형태를 크로스 케이블이라고 하고 케이블이 아닌 RJ-45에서 신호 회로로 전기 신호를 교환할 때 교차시킨 방식을 MDI-X, 교차시키지 않고 교환하는 방식을 MDI라고 한다.

  만약 송신 측이 MDI이고 수신 측이 MDI-X라면 신호선이 교차하지 않은 다이렉트 케이블을 사용하면 된다. 하지만 송신 측과 수신 측 모두 MDI이거나 MDI-X라면 중간에 신호선을 교차시켜주는 크로스 케이블을 이용해야 한다.

  요새는 장치가 알아서 MDI인지 MDI-X인지를 결정하는 기술인 Auto MDI/MDI-X 기술이 적용되고 있다. 그래서 다이렉트 케이블을 꽂던 크로스 케이블을 꽂던 장치들이 알아서 MDI 방식과 MDI-X 방식 중 하나를 선택해서 동작한다.

  이해를 돕기 위한 추가 자료 https://community.fs.com/blog/mdi-vs-mdix-and-auto-mdimdix-basis.html

- 리피터 허브의 기본

  이더넷의 기본 원리인 전체에 패킷을 뿌리고 신호를 수신하는 측이 받을지 말지 결정하는 원리에 따라 리피터 허브는 수신한 신호를 자신과 연결된 모든 기기에 송신하는 기능을 담당한다. 정말 이거 말고는 하는 일이 없다.

  리피터 허브는 전기 신호를 디지털 신호로 변환하는 과정 없이 전기신호인 채로 보내기 때문에 디지털 신호를 저장하는 메모리와 전기 신호와 디지털 신호의 변환을 담당하는 MAC 회로가 존재하지 않는다.

### 02. 스위칭 허브의 패킷 중계 동작

#### 스위칭 허브

- 스위칭 허브는 리피터 허브와 달리 커넥터에 연결된 장치 중 특정 장치에만 신호를 보낼 수 있도록 고안된 허브이다. 허브이기 때문에 MAC Address 기반으로 동작하며 MAC Address와 포트 번호를 비교하는 로직이 있기 때문에 커넥터마다 디지털 신호로 변환하는 과정을 거치고 FCS를 대조하여 오류의 유무를 검사한 뒤 변환된 신호를 메모리에 저장한다.
- LAN 어댑터와 거의 유사하지만 다른 점 중 하나는 LAN 어댑터의 경우 MAC 주소가 할당되어 있어 자기와 동일한 MAC 주소가 아니면 해당 데이터를 버리지만 허브는 그냥 다 받는다는 점이다.

<img src="/Users/cuzz/Documents/project-github/cuzzs-log/public/posts/network/image/network03_01.png" alt="network03_01" width="900" height="400" />

#### 패킷 중개 동작

- 스위칭 허브는 MAC 주소 테이블로 패킷을 중계한다. 수신처의 MAC 주소와 MAC 주소 표를 보고 특정 패킷이 어떤 포트로 송출되어야 할지 결정한 이후 스위치 허브를 이용해 해당 데이터를 목적지 포트로 보낸다.
- 스위치 허브는 특정 데이터를 수신할 때 해당 데이터가 들어온 포트와 해당 데이터의 송신처 MAC을 MAC 주소 테이블에 저장해둔다. 그리고 나중에 데이터를 송신할 때 해당 테이블의 MAC 주소와 보낼 데이터의 수신처 MAC 주소를 비교해 어떤 포트로 데이터를 송신할지 결정한다.
- 예외적인 경우가 몇 가지 있다.
  1. 패킷을 송신하는 포트와 수신하는 포트가 같은 경우 => 리피터 허브와 연결된 포트의 경우 리피터 허브 내 컴퓨터 A가 B로 패킷을 보낼 시 스위치 허브에도 신호가 오게 된다. 만약 스위치 허브가 여기서 신호를 내보내게 되면 B 컴퓨터에는 똑같은 두 개의 패킷이 도착하게 된다. 그래서 스위치 허브는 송신하는 포트와 수신하는 포트가 같으면 패킷을 중계하지 않고 폐기한다.
  2. MAC 주소 표에 수신처 MAC 주소와 일치하는 주소가 없는 경우가 있다. 해당 MAC 주소를 가진 기기에서 패킷이 한 번도 스위치 허브에 도착하지 않았거나 MAC 주소 표에서 삭제되었을 때 발생한다. 이런 경우 해당 패킷을 수신한 포트를 제외한 나머지 포트 전체에 패킷을 송신한다. 어차피 자신의 MAC 주소와 맞지 않은 패킷은 사용자가 버리기 때문에 크게 문제가 없다.
  3. 수신처의 MAC 주소가 브로드 캐스트 주소인 경우에도 수신한 포트를 제외한 나머지 모든 포트에 패킷을 송신한다.

#### 자동 조정

- 이더넷이 만들어진 초창기에는 하나의 선로에 여러 신호가 만나 서로 간섭해서 훼손되는 상황인 충돌 상황을 해결하기 위해 반이중 모드를 도입했다. 하지만 현재 트위스트 페어 케이블은 송신선과 수신선이 따로 있으며 대부분의 통신 관련 회로들은 송신과 수신을 따로 처리한다. 그리고 스위치 허브는 각 포트마다 상대 포트와 연결된 독립적인 통로를 가지고 있어 스위치 허브 내에서도 충돌이 발생하지 않는다. (리피터 허브는 통로를 공유하기 때문에 여러 컴퓨터가 동시에 데이터를 송신해오면 회로 내부에서 충돌이 발생한다.) 그래서 사람들은 이더넷의 규칙을 개정하여 송신과 수신을 동시에 진행할 수 있는 모드인 전이중 모드를 추가하게 된다.
  (http://egloos.zum.com/oxteen/v/5458427)

- 그렇다고 모든 통신 상대가 전이중 모드를 지원하는 건 아니므로 전이중 모드와 반이중 모드를 전환해야 할 필요성이 있었다. 맨 처음에는 이걸 수동으로 설정했다가 나중에는 동작 모드를 자동으로 전환하는 기능이 추가되었다. 동작 모드 뿐만 아니라 상대의 전송 속도에 맞춰 전송 속도도 자동으로 조정하는데 이 기능을 자동 조정이라고 한다.

- 이더넷은 데이터가 흐르지 않을 때 링크 펄스라는 펄스형 신호를 흘린다. 원래는 상대가 올바르게 동작하는지, 케이블에 단선은 없는지 검사하는 용도였으나 점차 발전하여 자신의 상황을 상대에게 전달하는 기능까지 추가되었다. 스위치는 해당 펄스 신호를 바탕으로 상대방의 정보를 파악하여 자동 조정 기능을 지원할 수 있게 되었다.

### 03. 라우터의 패킷 중계 동작

<img src="/Users/cuzz/Documents/project-github/cuzzs-log/public/posts/network/image/network03_02.png" alt="network03_02" width="800" height="320"/>

#### 라우터

- 스위칭 허브는 이더넷을 기반으로 중계 동작을 수행한다면 라우터는 IP를 기반으로 중계 동작을 수행한다. 라우터는 크게 중계 부분과 포트 부분으로 나눌 수 있는데 중계 부분은 컴퓨터의 IP 담당 부분과 같고, 포트 부분은 LAN 어댑터와 같다고 보면 된다.

- 라우터의 포트 부분부터 살펴보자면 컴퓨터가 LAN 어댑터를 교환해서 무선 LAN을 지원하는 것처럼 라우터도 무선 LAN용 하드웨어를 장착했다면 무선 LAN을 지원할 수 있다. 여기에 라우터는 LAN 이외의 통신 기술도 지원하는데 덕분에 ADSL, FTTH 등 광대역 회선과 전용 회선 등 다양한 기종과 연결이 가능하다.

  라우터의 각 포트에는 MAC 주소와 IP 주소가 할당되어 있어 패킷의 송신처 또는 수신처가 되어 패킷을 중계한다. MAC, IP 주소가 없어 송신처나 수신처 역할을 하지 못하는 스위치 허브와 다르고 컴퓨터의 LAN 어댑터와 유사합니다.

- 순수한 라우터는 IP 부분만 담당하고 실제로 패킷을 보내는 건 이더넷 부분에게 위임한다. 라우터는 망 전체에서 패킷이 어느 방향으로 가야 할지 정하지만 실제로 패킷을 보내는 것은 라우터에게 이 일을 위임받은 리피터 허브와 스위치 허브, 케이블이 진행한다.

#### 패킷 중계 동작

스위칭 허브와 가장 큰 차이점은 스위칭 허브는 MAC 주소를 기반으로 중계하지만, 라우터는 IP주소를 기반으로 중계한다.

- 라우터로 패킷이 들어오면 해당 패킷의 수신처 IP 정보를 입수한다. 이때 IP 주소에 넷마스크 정보를 이용해서 네트워크 번호만 추출하고 이를 이용해서 위치를 판단한다. 또한 현재 들어온 패킷이 얼마만큼 라우터를 더 거칠 수 있는지 나타내는 값인 TTL 값을 파악하고 TTL 값이 0인 패킷은 ICMP로 에러 메시지를 송신하고 폐기하며 0이 아닌 패킷은 TTL 값을 1씩 빼준다.
- 라우팅 테이블에는 수신처, 넷마스크, 게이트웨이, 인터페이스, 매트릭 정보가 저장된다. 수신처에는 네트워크 번호 또는 주소 집약이라는 개념을 이용하여 몇 개의 서브넷을 모아 한 개의 서브넷으로 간주한 네트워크 번호를 넣는다. 인터페이스는 해당 네트워크 번호가 가야 할 인터페이스(포트)를 나타내며 게이트웨이는 수신처가 0.0.0.0인 경우 가야 할 주소를 의미한다. 마지막으로 매트릭은 해당 수신처와의 거리를 나타낸다.
- 패킷에서 추출한 수신처 IP와 라우팅 테이블의 수신처 IP를 비교한다. 이때 완전히 같을 필요는 없고 둘 중 좀 더 짧은 IP 주소의 길이까지만 같으면 된다. 이런 방식이면 여러 길이의 라우팅 테이블 수신처 IP가 후보로 잡히는데 그중 길이가 가장 긴 주소를 선택한다. 가끔 단선 등을 염려해 우회로를 만드는 경우 길이가 같은 주소가 나올 수 있는데 이러면 매트릭의 길이가 짧은 쪽을 선택한다. 선택된 주소의 인터페이스로 해당 패킷이 이동하게 된다. 만약 완전히 일치하는 주소가 없으면 최종적으로 0.0.0.0에 매칭되어 게이트웨이로 이동하게 된다.
- 라우팅 테이블의 갱신은 사람이 수동으로 입력해주거나 라우팅 프로토콜을 이용해 라우터끼리 경로 정보를 교환하고 라우터 자체에서 경로표를 등록하는 방식이 있다. RIP, OSPF 등 여러 프로토콜이 존재한다.
- 참고로 패킷의 크기가 너무 크면 패킷을 분할해서 보낸다. 먼저 패킷을 쪼갤 수 있는지 확인한(이미 한 번 쪼갰거나 쪼개지 말라는 신호가 있으면 쪼개지 못하고 패킷을 버린다.) 후 IP 프로토콜에 의해 정의된 조각 나누기(fragmentation)을 이용해 패킷을 쪼개서 보낸다.

### 04. 라우터의 부가기능

#### 주소 변환 (NAT)

> 프라이빗 주소 (private address) : 사내에서만 쓰이는 주소, 프라이빗 주소를 만들 당시 할당되지 않았던 주소 중 일부를 프라이빗 주소의 범위로 정의하였다. 해당 범위 내의 IP 주소는 프라이빗 주소로만 사용된다.
> 글로벌 주소 (public address) : 전 세계에 쓰이는 공개된 주소, 이론상 0.0.0.0 부터 255.255.255.255까지 쓸 수 있지만 이런저런 이유로 전부 쓰지 못하고 IP 기기가 늘어나면서 주소 고갈 위험에 처했다.

- 프라이빗 주소 + 포트 < = > 글로벌 주소 + 포트로 변환해주는 기술이 바로 주소 변환이다. 특정 프라이빗 주소를 가진 컴퓨터가 외부 인터넷과 접속하려고 할 때 라우터는 해당 컴퓨터의 프라이빗 주소와 포트 번호를 저장하고 자신이 가진 글로벌 주소와 임의의 포트 번호로 변환하여 밖으로 내보낸다. 밖에서 처리된 후 다시 라우터로 돌아올 때 글로벌 주소와 포트 번호와 매칭되는 프라이빗 주소와 포트 번호로 해당 패킷을 전달해준다.
- 원래는 프라이빗 주소와 글로벌 주소를 일대일로 매칭했었다고 한다. 다만 이러면 사내 네트워크 안의 프라이빗 IP 개수만큼 글로벌 IP가 필요하기 때문에 포트 개념을 도입하였다. 포트를 도입함으로써 하나의 글로벌 IP에 라우터에 할당 가능한 포트 번호 수만큼 프라이빗 IP를 매칭시킬 수 있게 되었다.
- 다만 해당 글로벌 IP에 먼저 연락이 오는 경우는 좀 애매하나 이 또한 설정을 통해 외부로부터 들어오는 신호는 특정 private IP의 특정 port와 연결하도록 미리 지정하면 된다.

#### 패킷 필터링

패킷을 중계할 때 MAC 헤더, IP 헤더, TCP 헤더의 내용을 조사하여 사전에 설정된 조건에 따라 해당 패킷을 버리거나 수용하는 행위다. 서버 측을 탐험할 때 자세히 보도록 하자.
